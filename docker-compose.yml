version: "3.7"
services:

## uk based edge caches
## Emulating the Datacenter operating out of London

    uk-edge-envoy:
        # ports:
        #     - '80:80'
        #     - '443:443'
        #     - '9901:9901'
        restart: always
        logging:
            options:
                max-size: 1g
        image: warmfusion/evha-edge:latest
        volumes:
          - ${PWD}/conf/edge/envoy:/etc/envoy
        depends_on:
            - uk-edge-varnish
        deploy:
            replicas: 2
            labels:
                - traefik.evha-envoy.port=80
                - traefik.evha-envoy.frontend.rule=Host:evha.swarm.future.net.uk
                - traefik.docker.network=traefik_network
            update_config:
                parallelism: 1
                delay: 20s
                order: start-first
            placement:
                constraints:
                    - node.role == worker # Mandatory line
            restart_policy:
                condition: any


    uk-edge-varnish:
        restart: always
        # ports:
        #     - '81:6081'
        logging:
            options:
                max-size: 1g
        image: 'warmfusion/varnish:5.2.1-1-stretch'
        command: ["/opt/varnish/start-varnish.sh", "origin", "uk-origin-envoy"]
        volumes:
          - ${PWD}/conf/edge/varnish:/etc/varnish
        depends_on:
            - uk-origin-envoy
        deploy:
            replicas: 2
            update_config:
                parallelism: 1
                delay: 20s
                order: start-first
            placement:
                constraints:
                    - node.role == worker # Mandatory line
            restart_policy:
                condition: any

## uk based origin caches
## Emulating the resilient caches acting as origin caches

    uk-origin-envoy:
        # ports:
        #     - '8080:80'
        restart: always
        logging:
            options:
                max-size: 1g
        image: warmfusion/evha-origin:latest
        volumes:
          - ${PWD}/conf/origin/envoy:/etc/envoy
        depends_on:
            - uk-origin-varnish
        deploy:
            replicas: 2
            update_config:
                parallelism: 1
                delay: 20s
                order: start-first
            placement:
                constraints:
                    - node.role == worker # Mandatory line
            restart_policy:
                condition: any

    uk-origin-varnish:
        restart: always
        # ports:
        #     - '8081:6081'
        logging:
            options:
                max-size: 1g
        image: 'warmfusion/varnish:5.2.1-1-stretch'
        command: ["/opt/varnish/start-varnish.sh", "service", "uk-service", "4567"]
        volumes:
          - ${PWD}/conf/origin/varnish:/etc/varnish
        depends_on:
            - uk-service
        deploy:
            replicas: 2
            update_config:
                parallelism: 1
                delay: 20s
                order: start-first
            placement:
                constraints:
                    - node.role == worker # Mandatory line
            restart_policy:
                condition: any

## uk based origin backend service
## Emulating the services delivering functionality


    uk-service:
        image: warmfusion/evha-test-app:latest
        # ports:
        #     - '4567:4567'
        restart: always
        logging:
            options:
                max-size: 1g
        deploy:
            replicas: 1
            update_config:
                parallelism: 1
                delay: 20s
                order: stop-first
            placement:
                constraints:
                    - node.role == worker # Mandatory line
            restart_policy:
                condition: any
